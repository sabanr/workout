@page "/history"
@inject WorkoutService WorkoutService
@inject SettingsService SettingsService
@implements IDisposable

<PageTitle>History - IronTracker</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Workout History</MudText>

<MudPaper Class="pa-4 mb-4" Elevation="1">
    <MudGrid>
        <MudItem xs="12" sm="6" md="4">
            <MudDateRangePicker Label="Date Range" 
                                @bind-DateRange="_dateRange"
                                @bind-DateRange:after="LoadSessionsAsync"
                                Variant="Variant.Outlined"
                                MaxDate="DateTime.Today" />
        </MudItem>
        <MudItem xs="12" sm="6" md="4" Class="d-flex align-end">
            <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary">
                <MudButton OnClick="@(() => SetPresetRange(7))">7 Days</MudButton>
                <MudButton OnClick="@(() => SetPresetRange(30))">30 Days</MudButton>
                <MudButton OnClick="@(() => SetPresetRange(90))">90 Days</MudButton>
            </MudButtonGroup>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (_sessions == null || _sessions.Count == 0)
{
    <MudAlert Severity="Severity.Info" Class="mt-4">
        No workout sessions found in the selected date range. Complete some workouts to see your history!
    </MudAlert>
}
else
{
    <MudText Typo="Typo.subtitle1" Color="Color.Secondary" Class="mb-3">
        @_sessions.Count session@(_sessions.Count != 1 ? "s" : "") found
    </MudText>

    <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelinePosition="TimelinePosition.Start">
        @foreach (var session in _sessions)
        {
            <MudTimelineItem Color="@(session.IsActive ? Color.Warning : Color.Success)" Size="Size.Medium">
                <ItemOpposite>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @session.StartTime.ToLocalTime().ToString("ddd")
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @session.StartTime.ToLocalTime().ToString("MMM d")
                    </MudText>
                </ItemOpposite>
                <ItemContent>
                    <MudCard Elevation="1" Class="mb-2">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@session.RoutineDay?.Name</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @session.StartTime.ToLocalTime().ToString("MMM dd, yyyy HH:mm tt") - 
                                    @if (session.IsActive)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">
                                            In Progress
                                        </MudChip>
                                    }
                                    else
                                    {
                                        @FormatDuration(session.Duration)
                                    }
                                </MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                @if (!session.IsActive)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">
                                        @FormatVolume(SettingsService.ConvertToDisplayUnit(session.TotalVolume)) @SettingsService.GetUnitAbbreviation()
                                    </MudChip>
                                }
                            </CardHeaderActions>
                        </MudCardHeader>
                        
                        @if (session.SetLogs.Count > 0)
                        {
                            <MudCardContent Class="pt-0">
                                <MudExpansionPanels Elevation="0">
                                    <MudExpansionPanel Text="View Details" Dense="true">
                                        @{
                                            var groupedSets = session.SetLogs
                                                .GroupBy(s => s.ExerciseName)
                                                .OrderBy(g => g.First().CompletedAt);
                                        }
                                        
                                        <MudSimpleTable Dense="true" Hover="true" Style="background: transparent;">
                                            <thead>
                                                <tr>
                                                    <th>Exercise</th>
                                                    <th>Sets</th>
                                                    <th>Best Set</th>
                                                    <th>Volume</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var exercise in groupedSets)
                                                {
                                                    var sets = exercise.OrderBy(s => s.SetNumber).ToList();
                                                    var bestSet = sets.OrderByDescending(s => s.WeightUsed).ThenByDescending(s => s.RepsPerformed).First();
                                                    var exerciseVolume = sets.Sum(s => s.Volume);
                                                    
                                                    <tr>
                                                        <td>@exercise.Key</td>
                                                        <td>@sets.Count</td>
                                                        <td>@SettingsService.ConvertToDisplayUnit(bestSet.WeightUsed) @SettingsService.GetUnitAbbreviation() x @bestSet.RepsPerformed</td>
                                                        <td>@FormatVolume(SettingsService.ConvertToDisplayUnit(exerciseVolume)) @SettingsService.GetUnitAbbreviation()</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </MudSimpleTable>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            </MudCardContent>
                        }
                        
                        @if (!string.IsNullOrWhiteSpace(session.Notes))
                        {
                            <MudCardContent Class="pt-0">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Notes" Size="Size.Small" Class="mr-1" />
                                    @session.Notes
                                </MudText>
                            </MudCardContent>
                        }
                    </MudCard>
                </ItemContent>
            </MudTimelineItem>
        }
    </MudTimeline>
}

@code {
    private bool _loading = true;
    private List<WorkoutSession>? _sessions;
    private DateRange _dateRange = new(DateTime.Today.AddDays(-30), DateTime.Today);

    protected override async Task OnInitializedAsync()
    {
        SettingsService.WeightUnitChanged += OnWeightUnitChanged;
        await LoadSessionsAsync();
    }

    private void OnWeightUnitChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task LoadSessionsAsync()
    {
        _loading = true;
        StateHasChanged();

        var from = _dateRange.Start ?? DateTime.Today.AddDays(-30);
        var to = (_dateRange.End ?? DateTime.Today).AddDays(1); // Include end date fully

        _sessions = await WorkoutService.GetSessionHistoryAsync(from, to);
        _loading = false;
    }

    private async Task SetPresetRange(int days)
    {
        _dateRange = new DateRange(DateTime.Today.AddDays(-days), DateTime.Today);
        await LoadSessionsAsync();
    }

    private string FormatDuration(TimeSpan? duration)
    {
        if (!duration.HasValue)
            return "â€”";

        if (duration.Value.TotalHours >= 1)
            return $"{duration.Value.Hours}h {duration.Value.Minutes}m";

        return $"{duration.Value.Minutes}m";
    }

    private string FormatVolume(decimal volume)
    {
        if (volume >= 1000)
            return $"{volume / 1000:N1}k";
        return volume.ToString("N0");
    }

    public void Dispose()
    {
        SettingsService.WeightUnitChanged -= OnWeightUnitChanged;
    }
}
