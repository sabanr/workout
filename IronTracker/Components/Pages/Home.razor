@page "/"
@using IronTracker.Models
@using IronTracker.Services
@using IronTracker.Services.Interfaces
@inject WorkoutService WorkoutService
@inject SettingsService SettingsService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@implements IDisposable

<PageTitle>Dashboard - IronTracker</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <MudText Typo="Typo.h4">Dashboard</MudText>
    <MudIconButton Icon="@Icons.Material.Filled.Settings"
                   Size="Size.Medium"
                   OnClick="OpenDashboardSettings"
                   Title="Dashboard Settings" />
</div>

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudGrid>
        @* Streak Card *@
        @if (SettingsService.ShowStreakCard)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Style="min-height: 200px; height: 200px;">
                    <MudCardContent Class="d-flex flex-column align-center pa-6">
                        <MudIcon Icon="@Icons.Material.Filled.LocalFireDepartment"
                                 Color="@(_stats!.ConsecutiveDaysStreak > 0 ? Color.Warning : Color.Default)"
                                 Size="Size.Large" />
                        <MudText Typo="Typo.h2" Class="my-2">@_stats!.ConsecutiveDaysStreak</MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
                            Day@(_stats.ConsecutiveDaysStreak != 1 ? "s" : "") Streak
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }

        @* Quick Start Card *@
        @if (SettingsService.ShowQuickStartCard)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Style="min-height: 200px; height: 200px;">
                    <MudCardContent Class="d-flex flex-column align-center justify-center pa-6" Style="height: 100%;">
                        @if (_hasActiveSession)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.FitnessCenter" Color="Color.Success" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Class="my-2">Session Active</MudText>
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       OnClick="@(() => Navigation.NavigateTo("/session"))">
                                Continue Workout
                            </MudButton>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Color="Color.Primary" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Class="my-2">Ready to Train?</MudText>
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       OnClick="@(() => Navigation.NavigateTo("/session"))">
                                Start Workout
                            </MudButton>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }

        @* Total Sessions Card *@
        @if (SettingsService.ShowTotalSessionsCard)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Style="min-height: 200px; height: 200px;">
                    <MudCardContent Class="d-flex flex-column align-center pa-6">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Info" Size="Size.Large" />
                        <MudText Typo="Typo.h2" Class="my-2">@_stats!.RecentSessions.Count</MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Recent Sessions</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }

        @* Daily Volume Chart (Last 3 Months) *@
        @if (SettingsService.ShowVolumeChart)
        {
            <MudItem xs="12" md="8">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Daily Training Volume - Last 3 Months (@SettingsService.GetUnitAbbreviation())</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (_chartLabels.Length > 0)
                        {
                            <MudChart ChartType="ChartType.Bar"
                                      ChartSeries="_chartSeries"
                                      XAxisLabels="_chartLabels"
                                      Width="100%"
                                      Height="300px"
                                      ChartOptions="_chartOptions" />
                        }
                        else
                        {
                            <MudText Color="Color.Secondary" Class="text-center pa-8">
                                No workout data yet. Complete some sessions to see your progress!
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }

        @* Recent Sessions *@
        @if (SettingsService.ShowRecentActivity)
        {
            <MudItem xs="12" md="4">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Recent Activity</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent Style="max-height: 340px; overflow-y: auto;">
                        @if (_stats!.RecentSessions.Count > 0)
                        {
                            <MudList T="WorkoutSession" Dense="true">
                                @foreach (var session in _stats.RecentSessions)
                                {
                                    <MudListItem Icon="@Icons.Material.Filled.FitnessCenter">
                                        <div class="d-flex flex-column">
                                            <MudText Typo="Typo.body2">@session.RoutineDay?.Name</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @session.StartTime.ToLocalTime().ToString("ddd, MMM d") -
                                                @FormatDuration(session.Duration)
                                            </MudText>
                                        </div>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                        else
                        {
                            <MudText Color="Color.Secondary" Class="text-center pa-4">
                                No sessions yet
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
}

@code {
    private bool _loading = true;
    private bool _hasActiveSession;
    private DashboardStats? _stats;
    private List<ChartSeries> _chartSeries = new();
    private string[] _chartLabels = Array.Empty<string>();
    // Limit to 5 Y-axis ticks for better readability with formatted labels
    private ChartOptions _chartOptions = new() { YAxisTicks = 5 };

    protected override async Task OnInitializedAsync()
    {
        SettingsService.WeightUnitChanged += OnWeightUnitChanged;
        SettingsService.DashboardVisibilityChanged += OnDashboardVisibilityChanged;

        _loading = true;

        _hasActiveSession = await WorkoutService.HasActiveSessionAsync();
        _stats = await WorkoutService.GetDashboardStatsAsync();

        PrepareChartData();

        _loading = false;
    }

    private void OnWeightUnitChanged()
    {
        PrepareChartData();
        InvokeAsync(StateHasChanged);
    }

    private void OnDashboardVisibilityChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task OpenDashboardSettings()
    {
        await DialogService.ShowAsync<DashboardSettingsDialog>("Dashboard Settings");
    }

    private void PrepareChartData()
    {
        if (_stats?.WeeklyVolume == null || _stats.WeeklyVolume.Count == 0)
            return;

        var orderedData = _stats.WeeklyVolume
            .OrderBy(kv => kv.Key)
            .ToList();

        _chartLabels = orderedData
            .Select(kv => kv.Key.ToString("MMM d"))
            .ToArray();

        var values = orderedData
            .Select(kv => (double)SettingsService.ConvertToDisplayUnit(kv.Value))
            .ToArray();

        // Determine appropriate Y-axis format based on maximum value
        // Format string syntax: each comma divides by 1,000
        // e.g., "0,K" divides by 1,000 and adds "K"
        // e.g., "0,,.##M" divides by 1,000,000 and adds "M" with up to 2 decimals
        var maxValue = values.DefaultIfEmpty(0).Max();
        if (maxValue >= 1_000_000)
        {
            _chartOptions.YAxisFormat = "0,,.##M"; // e.g., "1.25M"
        }
        else if (maxValue >= 10_000)
        {
            _chartOptions.YAxisFormat = "0,K"; // e.g., "15K"
        }
        else if (maxValue >= 1_000)
        {
            _chartOptions.YAxisFormat = "0,.##K"; // e.g., "1.5K", "5K"
        }
        else
        {
            _chartOptions.YAxisFormat = "0"; // e.g., "500"
        }

        _chartSeries = new List<ChartSeries>
        {
            new ChartSeries
            {
                Name = "Volume",
                Data = values
            }
        };
    }

    private string FormatDuration(TimeSpan? duration)
    {
        if (!duration.HasValue)
            return "In progress";
        
        if (duration.Value.TotalHours >= 1)
            return $"{duration.Value.Hours}h {duration.Value.Minutes}m";
        
        return $"{duration.Value.Minutes}m";
    }

    public void Dispose()
    {
        SettingsService.WeightUnitChanged -= OnWeightUnitChanged;
        SettingsService.DashboardVisibilityChanged -= OnDashboardVisibilityChanged;
    }
}
