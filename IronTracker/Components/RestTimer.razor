@* RestTimer.razor - Countdown timer for rest between sets *@
@using System.Diagnostics
@using Plugin.Maui.Audio
@inject IStringLocalizer<AppResources> L

<MudPaper Class="pa-4 d-flex flex-column align-center" Elevation="2">
    <MudText Typo="Typo.subtitle1" Color="Color.Secondary">@L["RestTimer"]</MudText>
    
    <MudText Typo="Typo.h2" Class="my-4" Color="@GetTimerColor()">
        @TimeSpan.FromSeconds(_remainingSeconds).ToString(@"mm\:ss")
    </MudText>
    
    @if (_isRunning)
    {
        <MudProgressLinear Color="@GetTimerColor()" 
                           Value="@GetProgress()" 
                           Class="my-2" 
                           Style="width: 100%; max-width: 200px;" />
    }
    
    <MudStack Row="true" Spacing="2" Class="mt-2">
        @if (!_isRunning)
        {
                <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.PlayArrow"
                       OnClick="Start">
                @L["Start"]
            </MudButton>
        }
        else
        {
                <MudButton Variant="Variant.Outlined" 
                       Color="Color.Warning" 
                       StartIcon="@Icons.Material.Filled.SkipNext"
                       OnClick="Skip">
                @L["Skip"]
            </MudButton>
        }
        
        <MudButton Variant="Variant.Outlined" 
                   Color="Color.Default" 
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="AddTime"
                   Disabled="@(!_isRunning)">
            @L["AddThirtySeconds"]
        </MudButton>
        
        <MudButton Variant="Variant.Outlined" 
                   Color="Color.Default" 
                   StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="Reset">
            @L["Reset"]
        </MudButton>
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    public int DefaultSeconds { get; set; } = 60;
    
    [Parameter]
    public EventCallback OnTimerComplete { get; set; }
    
    [Parameter]
    public EventCallback OnTimerSkipped { get; set; }

    private int _remainingSeconds;
    private int _totalSeconds;
    private bool _isRunning;
    private System.Threading.Timer? _timer;
    private IAudioPlayer? _audioPlayer;
    private Stream? _audioStream;

    [Inject]
    private IAudioManager AudioManager { get; set; } = null!;

    protected override void OnInitialized()
    {
        _remainingSeconds = DefaultSeconds;
        _totalSeconds = DefaultSeconds;
    }

    public void Start()
    {
        if (_isRunning) return;
        
        _isRunning = true;
        _timer = new System.Threading.Timer(Tick, null, 1000, 1000);
    }

    public void StartWithDuration(int seconds)
    {
        _remainingSeconds = seconds;
        _totalSeconds = seconds;
        Start();
    }

    private async void Tick(object? state)
    {
        _remainingSeconds--;

        if (_remainingSeconds <= 0)
        {
            Stop();
            await PlayCompletionSoundAsync();
            await InvokeAsync(async () =>
            {
                await OnTimerComplete.InvokeAsync();
                StateHasChanged();
            });
        }
        else
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task PlayCompletionSoundAsync()
    {
        try
        {
            // Dispose previous audio player and stream if they exist
            _audioPlayer?.Dispose();
            _audioStream?.Dispose();

            // Open the audio file and keep the stream alive during playback
            _audioStream = await FileSystem.OpenAppPackageFileAsync("mysound.mp3");
            _audioPlayer = AudioManager.CreatePlayer(_audioStream);
            _audioPlayer.Play();
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"Error playing sound: {ex.Message}");
            Debug.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    private void Stop()
    {
        _isRunning = false;
        _timer?.Dispose();
        _timer = null;
    }

    private async Task Skip()
    {
        Stop();
        _remainingSeconds = DefaultSeconds;
        _totalSeconds = DefaultSeconds;
        await OnTimerSkipped.InvokeAsync();
    }

    private void Reset()
    {
        Stop();
        _remainingSeconds = DefaultSeconds;
        _totalSeconds = DefaultSeconds;
    }

    private void AddTime()
    {
        _remainingSeconds += 30;
        _totalSeconds += 30;
    }

    private double GetProgress()
    {
        if (_totalSeconds == 0) return 0;
        return ((double)_remainingSeconds / _totalSeconds) * 100;
    }

    private Color GetTimerColor()
    {
        if (!_isRunning) return Color.Default;
        if (_remainingSeconds <= 10) return Color.Error;
        if (_remainingSeconds <= 30) return Color.Warning;
        return Color.Success;
    }

    public void Dispose()
    {
        _timer?.Dispose();
        _audioPlayer?.Dispose();
        _audioStream?.Dispose();
    }
}
