@page "/"
@inject WorkoutService WorkoutService
@inject NavigationManager Navigation

<PageTitle>Dashboard - IronTracker</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Dashboard</MudText>

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudGrid>
        @* Streak Card *@
        <MudItem xs="12" sm="6" md="4">
            <MudCard>
                <MudCardContent Class="d-flex flex-column align-center pa-6">
                    <MudIcon Icon="@Icons.Material.Filled.LocalFireDepartment" 
                             Color="@(_stats!.ConsecutiveDaysStreak > 0 ? Color.Warning : Color.Default)" 
                             Size="Size.Large" />
                    <MudText Typo="Typo.h2" Class="my-2">@_stats!.ConsecutiveDaysStreak</MudText>
                    <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
                        Day@(_stats.ConsecutiveDaysStreak != 1 ? "s" : "") Streak
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        @* Quick Start Card *@
        <MudItem xs="12" sm="6" md="4">
            <MudCard>
                <MudCardContent Class="d-flex flex-column align-center pa-6">
                    @if (_hasActiveSession)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.FitnessCenter" Color="Color.Success" Size="Size.Large" />
                        <MudText Typo="Typo.h6" Class="my-2">Session Active</MudText>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   OnClick="@(() => Navigation.NavigateTo("/session"))">
                            Continue Workout
                        </MudButton>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Color="Color.Primary" Size="Size.Large" />
                        <MudText Typo="Typo.h6" Class="my-2">Ready to Train?</MudText>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   OnClick="@(() => Navigation.NavigateTo("/session"))">
                            Start Workout
                        </MudButton>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        @* Total Sessions Card *@
        <MudItem xs="12" sm="6" md="4">
            <MudCard>
                <MudCardContent Class="d-flex flex-column align-center pa-6">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Info" Size="Size.Large" />
                    <MudText Typo="Typo.h2" Class="my-2">@_stats!.RecentSessions.Count</MudText>
                    <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Recent Sessions</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        @* Weekly Volume Chart *@
        <MudItem xs="12" md="8">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Weekly Volume (lbs)</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (_chartLabels.Length > 0)
                    {
                        <MudChart ChartType="ChartType.Bar" 
                                  ChartSeries="_chartSeries" 
                                  XAxisLabels="_chartLabels"
                                  Width="100%"
                                  Height="300px"
                                  ChartOptions="_chartOptions" />
                    }
                    else
                    {
                        <MudText Color="Color.Secondary" Class="text-center pa-8">
                            No workout data yet. Complete some sessions to see your progress!
                        </MudText>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        @* Recent Sessions *@
        <MudItem xs="12" md="4">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Recent Activity</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Style="max-height: 340px; overflow-y: auto;">
                    @if (_stats!.RecentSessions.Count > 0)
                    {
                        <MudList T="WorkoutSession" Dense="true">
                            @foreach (var session in _stats.RecentSessions)
                            {
                                <MudListItem Icon="@Icons.Material.Filled.FitnessCenter">
                                    <div class="d-flex flex-column">
                                        <MudText Typo="Typo.body2">@session.RoutineDay?.Name</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @session.StartTime.ToLocalTime().ToString("ddd, MMM d") - 
                                            @FormatDuration(session.Duration)
                                        </MudText>
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else
                    {
                        <MudText Color="Color.Secondary" Class="text-center pa-4">
                            No sessions yet
                        </MudText>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
}

@code {
    private bool _loading = true;
    private bool _hasActiveSession;
    private DashboardStats? _stats;
    private List<ChartSeries> _chartSeries = new();
    private string[] _chartLabels = Array.Empty<string>();
    private ChartOptions _chartOptions = new() { YAxisTicks = 500 };

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        
        _hasActiveSession = await WorkoutService.HasActiveSessionAsync();
        _stats = await WorkoutService.GetDashboardStatsAsync();
        
        PrepareChartData();
        
        _loading = false;
    }

    private void PrepareChartData()
    {
        if (_stats?.WeeklyVolume == null || _stats.WeeklyVolume.Count == 0)
            return;

        var orderedData = _stats.WeeklyVolume
            .OrderBy(kv => kv.Key)
            .ToList();

        _chartLabels = orderedData
            .Select(kv => kv.Key.ToString("MMM d"))
            .ToArray();

        var values = orderedData
            .Select(kv => (double)kv.Value)
            .ToArray();

        _chartSeries = new List<ChartSeries>
        {
            new ChartSeries
            {
                Name = "Volume",
                Data = values
            }
        };
    }

    private string FormatDuration(TimeSpan? duration)
    {
        if (!duration.HasValue)
            return "In progress";
        
        if (duration.Value.TotalHours >= 1)
            return $"{duration.Value.Hours}h {duration.Value.Minutes}m";
        
        return $"{duration.Value.Minutes}m";
    }
}
