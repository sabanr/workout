@* SetTracker.razor - Tracks sets for a single exercise *@
@inject SettingsService SettingsService
@implements IDisposable

<MudPaper Class="pa-4" Elevation="1">
    <MudText Typo="Typo.h6" Class="mb-3">@Exercise.Name</MudText>
    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
        Target: @Exercise.TargetConfig
    </MudText>
    
    <MudSimpleTable Dense="true" Hover="true" Bordered="true">
        <thead>
            <tr>
                <th style="width: 60px;">Set</th>
                <th style="width: 80px;">Target</th>
                <th>Reps</th>
                <th>Weight (@SettingsService.GetUnitAbbreviation())</th>
                <th style="width: 80px;">Done</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < _sets.Count; i++)
            {
                var setIndex = i;
                var set = _sets[i];
                <tr class="@(set.IsCompleted ? "mud-theme-success" : "")">
                    <td class="text-center">
                        <MudText Typo="Typo.body2">@(setIndex + 1)</MudText>
                    </td>
                    <td class="text-center">
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@_targetReps[setIndex]</MudChip>
                    </td>
                    <td>
                        <MudNumericField T="int" 
                                        @bind-Value="set.Reps" 
                                        Variant="Variant.Outlined"
                                        Min="0" 
                                        Max="100"
                                        Disabled="@set.IsCompleted"
                                        Margin="Margin.Dense"
                                        HideSpinButtons="true" />
                    </td>
                    <td>
                        <MudNumericField T="decimal" 
                                        @bind-Value="set.DisplayWeight" 
                                        Variant="Variant.Outlined"
                                        Min="@SettingsService.GetMinWeight()" 
                                        Max="@SettingsService.GetMaxWeight()"
                                        Step="@SettingsService.GetWeightStepSize()"
                                        Disabled="@set.IsCompleted"
                                        Margin="Margin.Dense"
                                        HideSpinButtons="true"
                                        Placeholder="@GetWeightHint(setIndex)" />
                    </td>
                    <td class="text-center">
                        @if (set.IsCompleted)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                        }
                        else
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Check" 
                                          Color="Color.Primary"
                                          Size="Size.Small"
                                          OnClick="@(() => CompleteSetAsync(setIndex))"
                                          Disabled="@(set.Reps <= 0)" />
                        }
                    </td>
                </tr>
            }
        </tbody>
    </MudSimpleTable>
    
    @if (CompletedSetsCount == _sets.Count && _sets.Count > 0)
    {
        <MudAlert Severity="Severity.Success" Class="mt-3" Dense="true">
            Exercise completed!
        </MudAlert>
    }
</MudPaper>

@code {
    [Parameter, EditorRequired]
    public ExerciseTemplate Exercise { get; set; } = null!;
    
    [Parameter]
    public int SessionId { get; set; }
    
    [Parameter]
    public List<SetLog>? ExistingLogs { get; set; }
    
    [Parameter]
    public Dictionary<int, decimal>? LastWeights { get; set; }
    
    [Parameter]
    public EventCallback<SetCompletedEventArgs> OnSetCompleted { get; set; }

    private List<SetEntry> _sets = new();
    private int[] _targetReps = Array.Empty<int>();
    private decimal[] _targetWeights = Array.Empty<decimal>();
    
    public int CompletedSetsCount => _sets.Count(s => s.IsCompleted);
    public bool IsExerciseComplete => _sets.Count > 0 && _sets.All(s => s.IsCompleted);

    protected override void OnInitialized()
    {
        SettingsService.WeightUnitChanged += OnWeightUnitChanged;
    }

    protected override void OnParametersSet()
    {
        _targetReps = Exercise.GetTargetReps();
        _targetWeights = Exercise.GetTargetWeights();
        InitializeSets();
    }

    private void OnWeightUnitChanged()
    {
        // Convert existing display weights to the new unit
        // For incomplete sets, we need to convert from the old display unit to lbs,
        // then from lbs to the new display unit
        foreach (var set in _sets.Where(s => !s.IsCompleted))
        {
            // The current DisplayWeight is in the old unit
            // First convert to lbs (storage unit), then to new display unit
            var weightInLbs = ConvertFromOldDisplayUnit(set.DisplayWeight);
            set.DisplayWeight = SettingsService.ConvertToDisplayUnit(weightInLbs);
        }

        InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Converts a weight from the old display unit to lbs.
    /// This is needed when the unit changes while the user is editing.
    /// </summary>
    private decimal ConvertFromOldDisplayUnit(decimal weightInOldDisplayUnit)
    {
        // The old unit is the opposite of the current unit
        // If current is Lbs, old was Kg
        // If current is Kg, old was Lbs
        if (SettingsService.WeightUnit == WeightUnit.Lbs)
        {
            // Current is Lbs, so old was Kg: kg * 2.20462 = lbs
            return Math.Round(weightInOldDisplayUnit * 2.20462m, 2);
        }
        else
        {
            // Current is Kg, so old was Lbs: lbs (already in lbs)
            return weightInOldDisplayUnit;
        }
    }

    private void InitializeSets()
    {
        _sets.Clear();
        
        for (int i = 0; i < _targetReps.Length; i++)
        {
            var setNumber = i + 1;
            var existingLog = ExistingLogs?.FirstOrDefault(l => l.SetNumber == setNumber);
            
            // Weight priority: existing log > template weight > last session weight > 0
            decimal weightInLbs = existingLog?.WeightUsed ?? 0;
            if (weightInLbs == 0 && i < _targetWeights.Length && _targetWeights[i] > 0)
            {
                weightInLbs = _targetWeights[i];
            }
            else if (weightInLbs == 0 && LastWeights != null && LastWeights.TryGetValue(setNumber, out var lastWeight))
            {
                weightInLbs = lastWeight;
            }
            
            // Convert to display unit
            var displayWeight = SettingsService.ConvertToDisplayUnit(weightInLbs);
            
            _sets.Add(new SetEntry
            {
                SetNumber = setNumber,
                Reps = existingLog?.RepsPerformed ?? _targetReps[i],
                DisplayWeight = displayWeight,
                IsCompleted = existingLog != null,
                LogId = existingLog?.Id
            });
        }
    }

    private string GetWeightHint(int setIndex)
    {
        var setNumber = setIndex + 1;
        
        // Show template weight as hint if defined
        if (setIndex < _targetWeights.Length && _targetWeights[setIndex] > 0)
        {
            var targetDisplay = SettingsService.ConvertToDisplayUnit(_targetWeights[setIndex]);
            return $"Target: {targetDisplay}";
        }
        
        // Fall back to last session weight
        if (LastWeights != null && LastWeights.TryGetValue(setNumber, out var lastWeight) && lastWeight > 0)
        {
            var lastDisplay = SettingsService.ConvertToDisplayUnit(lastWeight);
            return $"Last: {lastDisplay}";
        }
        
        return "";
    }

    private async Task CompleteSetAsync(int setIndex)
    {
        var set = _sets[setIndex];
        if (set.IsCompleted || set.Reps <= 0) return;

        set.IsCompleted = true;

        // Convert display weight back to lbs for storage
        var weightInLbs = SettingsService.ConvertToStorageUnit(set.DisplayWeight);

        var args = new SetCompletedEventArgs
        {
            SessionId = SessionId,
            ExerciseName = Exercise.Name,
            SetNumber = set.SetNumber,
            Reps = set.Reps,
            Weight = weightInLbs
        };

        await OnSetCompleted.InvokeAsync(args);
    }

    public void LoadExistingLogs(List<SetLog> logs)
    {
        ExistingLogs = logs;
        InitializeSets();
        StateHasChanged();
    }

    public void Dispose()
    {
        SettingsService.WeightUnitChanged -= OnWeightUnitChanged;
    }

    private class SetEntry
    {
        public int SetNumber { get; set; }
        public int Reps { get; set; }
        public decimal DisplayWeight { get; set; }
        public bool IsCompleted { get; set; }
        public int? LogId { get; set; }
    }
}
