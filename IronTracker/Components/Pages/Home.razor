@page "/"
@using IronTracker.Models
@using IronTracker.Services
@using IronTracker.Services.Interfaces
@inject WorkoutService WorkoutService
@inject SettingsService SettingsService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IStringLocalizer<AppResources> L
@implements IDisposable

<PageTitle>@L["Dashboard"] - IronTracker</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <MudText Typo="Typo.h4">@L["Dashboard"]</MudText>
    <MudIconButton Icon="@Icons.Material.Filled.Settings"
                   Size="Size.Medium"
                   OnClick="OpenDashboardSettings"
                   Title="@L["DashboardSettings"]" />
</div>

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudGrid>
        @* Streak Card *@
        @if (SettingsService.ShowStreakCard)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Style="min-height: 200px; height: 200px;">
                    <MudCardContent Class="d-flex flex-column align-center pa-6">
                        <MudIcon Icon="@Icons.Material.Filled.LocalFireDepartment"
                                 Color="@(_stats!.ConsecutiveDaysStreak > 0 ? Color.Warning : Color.Default)"
                                 Size="Size.Large" />
                        <MudText Typo="Typo.h2" Class="my-2">@_stats!.ConsecutiveDaysStreak</MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
                            @L["DaysStreakLabel"]
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }

        @* Quick Start Card *@
        @if (SettingsService.ShowQuickStartCard)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Style="min-height: 200px; height: 200px;">
                    <MudCardContent Class="d-flex flex-column align-center justify-center pa-6" Style="height: 100%;">
                        @if (_hasActiveSession)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.FitnessCenter" Color="Color.Success" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Class="my-2">@L["SessionActive"]</MudText>
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       OnClick="@(() => Navigation.NavigateTo("/session"))">
                                @L["ContinueWorkout"]
                            </MudButton>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Color="Color.Primary" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Class="my-2">@L["ReadyToTrain"]</MudText>
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       OnClick="@(() => Navigation.NavigateTo("/session"))">
                                @L["StartWorkout"]
                            </MudButton>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }

        @* Rolling Stats Cards (Last 30 Days) *@
        @if (SettingsService.ShowWorkoutsCard)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Style="min-height: 200px; height: 200px;">
                    <MudCardContent Class="d-flex flex-column align-center pa-6">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Primary" Size="Size.Large" />
                        <MudText Typo="Typo.h2" Class="my-2">@_stats!.WorkoutsThisMonth</MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Secondary" Align="Align.Center">
                            @L["Workouts"] (30d)
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }

        @if (SettingsService.ShowVolumeCard)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Style="min-height: 200px; height: 200px;">
                    <MudCardContent Class="d-flex flex-column align-center pa-6">
                        <MudIcon Icon="@Icons.Material.Filled.FitnessCenter" Color="Color.Secondary" Size="Size.Large" />
                        <MudText Typo="Typo.h2" Class="my-2">@FormatVolume(_stats!.VolumeThisMonth)</MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Secondary" Align="Align.Center">
                            @L["Volume"] (30d)
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }

        @if (SettingsService.ShowAvgDurationCard)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Style="min-height: 200px; height: 200px;">
                    <MudCardContent Class="d-flex flex-column align-center pa-6">
                        <MudIcon Icon="@Icons.Material.Filled.Timer" Color="Color.Info" Size="Size.Large" />
                        <MudText Typo="Typo.h2" Class="my-2">@FormatDurationShort(_stats!.AverageDuration)</MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Secondary" Align="Align.Center">
                            @L["AvgDuration"] (30d)
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }

        @if (SettingsService.ShowFavoriteRoutineCard)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Style="min-height: 200px; height: 200px;">
                    <MudCardContent Class="d-flex flex-column align-center pa-6">
                        <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Large" />
                        <MudText Typo="@(GetTypographyForRoutine(_stats!.FavoriteRoutineName))" Class="my-2 text-truncate" Style="max-width: 100%;">
                            @(_stats!.FavoriteRoutineName ?? "-")
                        </MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Secondary" Align="Align.Center">
                            @L["Favorite"] (30d)
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }

        @if (SettingsService.ShowFrequencyCard)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Style="min-height: 200px; height: 200px;">
                    <MudCardContent Class="d-flex flex-column align-center pa-6">
                        <MudIcon Icon="@Icons.Material.Filled.ShowChart" Color="Color.Success" Size="Size.Large" />
                        <MudText Typo="Typo.h2" Class="my-2">@($"{_stats!.TrainingFrequency:F0}%")</MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Secondary" Align="Align.Center">
                            @L["Consistency"] (30d)
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }

        @* Daily Volume Chart (Last 3 Months) *@
        @if (SettingsService.ShowVolumeChart)
        {
            <MudItem xs="12" md="8">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@L["DailyTrainingVolumeLast3Months", SettingsService.GetUnitAbbreviation()]</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (_chartLabels.Length > 0)
                        {
                            <MudChart ChartType="ChartType.Bar"
                                      ChartSeries="_chartSeries"
                                      XAxisLabels="_chartLabels"
                                      Width="100%"
                                      Height="300px"
                                      ChartOptions="_chartOptions" />
                        }
                        else
                        {
                            <MudText Color="Color.Secondary" Class="text-center pa-8">
                                @L["NoWorkoutDataYet"]
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }

        @* Recent Sessions *@
        @if (SettingsService.ShowRecentActivity)
        {
            <MudItem xs="12" md="4">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@L["RecentActivity"]</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent Style="max-height: 340px; overflow-y: auto;">
                        @if (_stats!.RecentSessions.Count > 0)
                        {
                            <MudList T="WorkoutSession" Dense="true">
                                @foreach (var session in _stats.RecentSessions)
                                {
                                    <MudListItem Icon="@Icons.Material.Filled.FitnessCenter">
                                        <div class="d-flex flex-column">
                                            <MudText Typo="Typo.body2">@session.RoutineDay?.Name</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @session.StartTime.ToLocalTime().ToString("ddd, MMM d") -
                                                @FormatDuration(session.Duration)
                                            </MudText>
                                        </div>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                        else
                        {
                            <MudText Color="Color.Secondary" Class="text-center pa-4">
                                @L["NoSessionsYet"]
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
}

@code {
    private bool _loading = true;
    private bool _hasActiveSession;
    private DashboardStats? _stats;
    private List<ChartSeries> _chartSeries = new();
    private string[] _chartLabels = Array.Empty<string>();
    // Limit to 5 Y-axis ticks for better readability with formatted labels
    private ChartOptions _chartOptions = new() { YAxisTicks = 5 };

    protected override async Task OnInitializedAsync()
    {
        SettingsService.WeightUnitChanged += OnWeightUnitChanged;
        SettingsService.DashboardVisibilityChanged += OnDashboardVisibilityChanged;

        _loading = true;

        _hasActiveSession = await WorkoutService.HasActiveSessionAsync();
        _stats = await WorkoutService.GetDashboardStatsAsync();

        PrepareChartData();

        _loading = false;
    }

    private void OnWeightUnitChanged()
    {
        PrepareChartData();
        InvokeAsync(StateHasChanged);
    }

    private void OnDashboardVisibilityChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task OpenDashboardSettings()
    {
        await DialogService.ShowAsync<DashboardSettingsDialog>(L["DashboardSettings"].Value);
    }

    private void PrepareChartData()
    {
        if (_stats?.WeeklyVolume == null || _stats.WeeklyVolume.Count == 0)
            return;

        var orderedData = _stats.WeeklyVolume
            .OrderBy(kv => kv.Key)
            .ToList();

        _chartLabels = orderedData
            .Select(kv => kv.Key.ToString("MMM d"))
            .ToArray();

        var values = orderedData
            .Select(kv => (double)SettingsService.ConvertToDisplayUnit(kv.Value))
            .ToArray();

        // Determine appropriate Y-axis format based on maximum value
        // Format string syntax: each comma divides by 1,000
        // e.g., "0,K" divides by 1,000 and adds "K"
        // e.g., "0,,.##M" divides by 1,000,000 and adds "M" with up to 2 decimals
        var maxValue = values.DefaultIfEmpty(0).Max();
        if (maxValue >= 1_000_000)
        {
            _chartOptions.YAxisFormat = "0,,.##M"; // e.g., "1.25M"
        }
        else if (maxValue >= 10_000)
        {
            _chartOptions.YAxisFormat = "0,K"; // e.g., "15K"
        }
        else if (maxValue >= 1_000)
        {
            _chartOptions.YAxisFormat = "0,.##K"; // e.g., "1.5K", "5K"
        }
        else
        {
            _chartOptions.YAxisFormat = "0"; // e.g., "500"
        }

        _chartSeries = new List<ChartSeries>
        {
            new ChartSeries
            {
                Name = L["Volume"],
                Data = values
            }
        };
    }

    private string FormatDuration(TimeSpan? duration)
    {
        if (!duration.HasValue)
            return L["InProgress"];
        
        if (duration.Value.TotalHours >= 1)
            return $"{duration.Value.Hours}h {duration.Value.Minutes}m";
        
        return $"{duration.Value.Minutes}m";
    }

    private string FormatVolume(decimal volume)
    {
        var displayVolume = SettingsService.ConvertToDisplayUnit(volume);
        var unit = SettingsService.GetUnitAbbreviation();
        
        if (displayVolume >= 1_000_000)
            return $"{(displayVolume / 1_000_000):F1}M {unit}";
        if (displayVolume >= 1_000)
            return $"{(displayVolume / 1_000):F1}K {unit}";
            
        return $"{displayVolume:F0} {unit}";
    }

    private string FormatDurationShort(TimeSpan duration)
    {
        if (duration.TotalMinutes < 1)
            return "-";
        
        return $"{Math.Round(duration.TotalMinutes)}m";
    }

    private Typo GetTypographyForRoutine(string? name)
    {
        if (string.IsNullOrEmpty(name)) return Typo.h2;
        if (name.Length > 15) return Typo.h5;
        if (name.Length > 10) return Typo.h4;
        return Typo.h3;
    }

    public void Dispose()
    {
        SettingsService.WeightUnitChanged -= OnWeightUnitChanged;
        SettingsService.DashboardVisibilityChanged -= OnDashboardVisibilityChanged;
    }
}
